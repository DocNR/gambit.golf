package main

import (
	"strconv"
)

type GolfRoundPageParams struct {
	BaseEventPageParams
	OpenGraphParams
	HeadParams
	Details   DetailsParams
	Round     RoundPageData
	Clients   []ClientReference
}

templ golfRoundTemplate(params GolfRoundPageParams, isEmbed bool) {
	<!DOCTYPE html>
	if isEmbed {
		@embeddedPageTemplate(
			params.Event,
			params.NeventNaked,
		) {
			@golfRoundContent(params)
		}
	} else {
		<html class="theme--default font-light print:text-base">
			<meta charset="UTF-8"/>
			<head>
				<title>Golf Round</title>
				@openGraphTemplate(params.OpenGraphParams)
				@headCommonTemplate(params.HeadParams)
			</head>
			<body class="mb-16 bg-white text-gray-600 dark:bg-neutral-900 dark:text-neutral-50 print:text-black">
				@topTemplate(params.HeadParams)
				<div class="mx-auto w-full max-w-screen-2xl px-4 pb-4">
					@golfRoundContent(params)
				</div>
			</body>
		</html>
	}
}

templ golfRoundContent(params GolfRoundPageParams) {
	<div class="max-w-6xl mx-auto p-4 md:p-6" style="color: #111827;">
		<!-- Scorecard Card -->
		<div class="bg-white border-2 border-gray-800 rounded-lg shadow-xl overflow-hidden" style="color: #111827;">
			<!-- Header -->
			<div class="bg-gray-100 border-b-2 border-gray-800 p-4">
				<div class="flex items-center justify-between flex-wrap gap-2">
					<div class="flex-1 min-w-0">
						<h1 class="text-xl md:text-2xl font-bold text-gray-900 truncate">
							if params.Round.CourseName != "" {
								{ params.Round.CourseName }
							} else {
								Golf Round
							}
						</h1>
						<div class="flex items-center gap-3 mt-1 text-sm text-gray-600">
							if params.Round.TeeSet != "" {
								<span>{ params.Round.TeeSet } tees</span>
							}
							if params.Round.Date != "" {
								<span>{ formatDate(params.Round.Date) }</span>
							}
							<span class="font-mono">Par { strconv.Itoa(params.Round.TotalPar) }</span>
						</div>
					</div>
					<div class="flex-shrink-0">
						if params.Round.State == "final" {
							<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-gray-800 text-white uppercase tracking-wide">
								Final
							</span>
						} else if params.Round.State == "live" {
							<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-green-600 text-white uppercase tracking-wide">
								<span class="w-2 h-2 bg-white rounded-full mr-1.5 animate-pulse"></span>
								Live
							</span>
						} else {
							<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-yellow-500 text-white uppercase tracking-wide">
								Waiting
							</span>
						}
					</div>
				</div>
			</div>

			<!-- Scorecard Tables -->
			if len(params.Round.PlayerScores) > 0 {
				<div class="p-3 md:p-4">
					<!-- Front Nine -->
					<div class="mb-4 overflow-x-auto">
						<table class="w-full border-collapse border-2 border-gray-800 bg-white text-center" style="min-width: 600px;">
							<thead>
								<tr class="bg-gray-200">
									<th class="border border-gray-800 px-1.5 py-2 text-xs font-bold text-gray-900 uppercase text-left" style="min-width: 80px;">Hole</th>
									for i := 1; i <= 9; i++ {
										<th class="border border-gray-800 px-1.5 py-2 text-sm font-bold text-gray-900 font-mono">{ strconv.Itoa(i) }</th>
									}
									<th class="border border-gray-800 px-1.5 py-2 text-xs font-bold text-gray-900 bg-yellow-200 uppercase">Out</th>
								</tr>
							</thead>
							<tbody>
								<!-- Par Row -->
								if len(params.Round.HolePars) >= 9 {
									<tr class="bg-gray-50">
										<td class="border border-gray-800 px-1.5 py-1.5 text-xs font-bold text-gray-600 uppercase text-left">Par</td>
										for i := 0; i < 9; i++ {
											<td class="border border-gray-800 px-1.5 py-1.5 text-sm font-mono text-gray-600">{ strconv.Itoa(params.Round.HolePars[i]) }</td>
										}
										<td class="border border-gray-800 px-1.5 py-1.5 text-sm font-mono text-gray-600 bg-yellow-100">{ strconv.Itoa(sumSlice(params.Round.HolePars, 0, 9)) }</td>
									</tr>
								}
								<!-- Player Score Rows -->
								for _, ps := range params.Round.PlayerScores {
									<tr>
										<td class="border border-gray-800 px-1.5 py-2 text-left">
											<div class="flex items-center gap-1.5">
												if ps.Player.Picture != "" {
													<img src={ ps.Player.Picture } alt="" class="w-5 h-5 rounded-full flex-shrink-0"/>
												}
												<span class="text-xs font-bold text-gray-900 truncate">{ ps.Player.DisplayName }</span>
												if !ps.IsFinal {
													<span class="w-1.5 h-1.5 bg-green-500 rounded-full flex-shrink-0" title="In progress"></span>
												}
											</div>
										</td>
										for i := 0; i < 9; i++ {
											<td class={ scoreCellClass(ps.HoleScores, params.Round.HolePars, i) }>
												{ scoreDisplay(ps.HoleScores, i) }
											</td>
										}
										<td class="border border-gray-800 px-1.5 py-2 text-sm font-bold font-mono text-gray-900 bg-yellow-100">
											{ nineTotal(ps.HoleScores, 0, 9) }
										</td>
									</tr>
								}
							</tbody>
						</table>
					</div>

					<!-- Back Nine -->
					if params.Round.HoleCount > 9 {
						<div class="mb-4 overflow-x-auto">
							<table class="w-full border-collapse border-2 border-gray-800 bg-white text-center" style="min-width: 700px;">
								<thead>
									<tr class="bg-gray-200">
										<th class="border border-gray-800 px-1.5 py-2 text-xs font-bold text-gray-900 uppercase text-left" style="min-width: 80px;">Hole</th>
										for i := 10; i <= 18; i++ {
											<th class="border border-gray-800 px-1.5 py-2 text-sm font-bold text-gray-900 font-mono">{ strconv.Itoa(i) }</th>
										}
										<th class="border border-gray-800 px-1.5 py-2 text-xs font-bold text-gray-900 bg-yellow-200 uppercase">In</th>
										<th class="border border-gray-800 px-1.5 py-2 text-xs font-bold text-gray-900 bg-green-200 uppercase">Tot</th>
									</tr>
								</thead>
								<tbody>
									<!-- Par Row -->
									if len(params.Round.HolePars) >= 18 {
										<tr class="bg-gray-50">
											<td class="border border-gray-800 px-1.5 py-1.5 text-xs font-bold text-gray-600 uppercase text-left">Par</td>
											for i := 9; i < 18; i++ {
												<td class="border border-gray-800 px-1.5 py-1.5 text-sm font-mono text-gray-600">{ strconv.Itoa(params.Round.HolePars[i]) }</td>
											}
											<td class="border border-gray-800 px-1.5 py-1.5 text-sm font-mono text-gray-600 bg-yellow-100">{ strconv.Itoa(sumSlice(params.Round.HolePars, 9, 18)) }</td>
											<td class="border border-gray-800 px-1.5 py-1.5 text-sm font-mono text-gray-600 bg-green-100">{ strconv.Itoa(params.Round.TotalPar) }</td>
										</tr>
									}
									<!-- Player Score Rows -->
									for _, ps := range params.Round.PlayerScores {
										<tr>
											<td class="border border-gray-800 px-1.5 py-2 text-left">
												<div class="flex items-center gap-1.5">
													if ps.Player.Picture != "" {
														<img src={ ps.Player.Picture } alt="" class="w-5 h-5 rounded-full flex-shrink-0"/>
													}
													<span class="text-xs font-bold text-gray-900 truncate">{ ps.Player.DisplayName }</span>
												</div>
											</td>
											for i := 9; i < 18; i++ {
												<td class={ scoreCellClass(ps.HoleScores, params.Round.HolePars, i) }>
													{ scoreDisplay(ps.HoleScores, i) }
												</td>
											}
											<td class="border border-gray-800 px-1.5 py-2 text-sm font-bold font-mono text-gray-900 bg-yellow-100">
												{ nineTotal(ps.HoleScores, 9, 18) }
											</td>
											<td class="border border-gray-800 px-1.5 py-2 text-sm font-bold font-mono bg-green-100">
												<span class={ totalScoreClass(ps.ScoreToPar) }>
													{ strconv.Itoa(ps.Total) }
												</span>
											</td>
										</tr>
									}
								</tbody>
							</table>
						</div>
					}
				</div>

				<!-- Summary Bar -->
				<div class="border-t-2 border-gray-800 bg-gray-50 p-4">
					<div class="flex flex-wrap gap-4 justify-center">
						for _, ps := range params.Round.PlayerScores {
							<div class="flex items-center gap-2">
								if ps.Player.Picture != "" {
									<img src={ ps.Player.Picture } alt="" class="w-6 h-6 rounded-full"/>
								}
								<span class="text-sm font-semibold text-gray-900">{ ps.Player.DisplayName }</span>
								<span class={ "text-lg font-bold font-mono " + totalScoreClass(ps.ScoreToPar) }>
									{ strconv.Itoa(ps.Total) }
								</span>
								<span class={ "text-sm font-mono " + totalScoreClass(ps.ScoreToPar) }>
									({ formatScoreToPar(ps.ScoreToPar) })
								</span>
							</div>
						}
					</div>
				</div>
			} else {
				<!-- No scores yet -->
				<div class="p-8 text-center">
					<p class="text-gray-500 text-lg">
						if params.Round.State == "waiting" {
							Waiting for players to start scoring...
						} else {
							No scores available yet.
						}
					</p>
					<!-- Player list -->
					if len(params.Round.Players) > 0 {
						<div class="mt-4 flex flex-wrap gap-2 justify-center">
							for _, player := range params.Round.Players {
								<div class="flex items-center gap-1.5 bg-gray-100 px-3 py-1.5 rounded-full">
									if player.Picture != "" {
										<img src={ player.Picture } alt="" class="w-5 h-5 rounded-full"/>
									}
									<span class="text-sm font-medium text-gray-700">{ player.DisplayName }</span>
									if player.Role == "bot" {
										<span class="text-xs bg-gray-300 text-gray-600 px-1.5 py-0.5 rounded">bot</span>
									}
								</div>
							}
						</div>
					}
				</div>
			}

			<!-- Notes -->
			if params.Round.Notes != "" {
				<div class="border-t border-gray-300 p-4">
					<p class="text-sm text-gray-600 whitespace-pre-wrap">{ params.Round.Notes }</p>
				</div>
			}
		</div>

		<!-- Comments Section -->
		<div class="mt-4 bg-white border-2 border-gray-800 rounded-lg shadow-xl overflow-hidden" style="color: #111827;" id="comments-section">
			<div class="bg-gray-100 border-b-2 border-gray-800 px-4 py-3 flex items-center justify-between">
				<h2 class="text-sm font-bold text-gray-900 uppercase tracking-wide">
					Comments
					if len(params.Round.Comments) > 0 {
						<span class="ml-1 text-gray-500 font-normal">({ strconv.Itoa(len(params.Round.Comments)) })</span>
					}
				</h2>
				<!-- NIP-07 Login Button -->
				<button
					id="nostr-login-btn"
					onclick="connectNostrComment()"
					class="flex items-center gap-1.5 bg-gray-800 hover:bg-gray-700 text-white text-xs font-semibold px-3 py-1.5 rounded-lg transition-colors"
				>
					<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/><line x1="2" y1="12" x2="22" y2="12"/></svg>
					<span id="nostr-login-text">Sign in with Nostr</span>
				</button>
			</div>

			<!-- Server-rendered comments -->
			<div class="divide-y divide-gray-200" id="comments-list">
				if len(params.Round.Comments) > 0 {
					for _, c := range params.Round.Comments {
						<div class={ "px-4 py-3" + commentBgClass(c) }>
							<div class="flex items-start gap-2.5">
								if c.Author.Picture != "" {
									<img src={ c.Author.Picture } alt="" class="w-7 h-7 rounded-full flex-shrink-0 mt-0.5"/>
								} else {
									<div class="w-7 h-7 rounded-full bg-gray-300 flex-shrink-0 mt-0.5"></div>
								}
								<div class="flex-1 min-w-0">
									<div class="flex items-center gap-2">
										<span class="text-sm font-semibold text-gray-900">{ c.Author.DisplayName }</span>
										if c.IsPinned {
											<span class="text-xs bg-yellow-200 text-yellow-800 px-1.5 py-0.5 rounded font-medium">{ c.Type }</span>
										}
										<span class="text-xs text-gray-400">{ formatCommentTime(c.CreatedAt) }</span>
									</div>
									<p class="text-sm text-gray-700 mt-0.5 whitespace-pre-wrap break-words">{ c.Content }</p>
								</div>
							</div>
						</div>
					}
				} else {
					<div class="px-4 py-6 text-center text-sm text-gray-400" id="no-comments-msg">
						No comments yet. Be the first!
					</div>
				}
			</div>

			<!-- Comment Compose (hidden until logged in) -->
			<div id="comment-compose" class="border-t-2 border-gray-800 p-3 hidden">
				<div class="flex gap-2">
					<img id="compose-avatar" src="" alt="" class="w-7 h-7 rounded-full flex-shrink-0 mt-0.5 hidden"/>
					<div class="flex-1">
						<textarea
							id="comment-input"
							rows="2"
							placeholder="Add a comment..."
							class="w-full bg-gray-50 border border-gray-300 rounded-lg px-3 py-2 text-sm text-gray-900 placeholder-gray-400 focus:outline-none focus:border-green-500 focus:ring-1 focus:ring-green-500 resize-none"
						></textarea>
						<div class="flex items-center justify-between mt-1.5">
							<span id="comment-status" class="text-xs text-gray-400"></span>
							<button
								id="comment-send-btn"
								onclick="sendComment()"
								disabled
								class="bg-green-600 hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white text-xs font-semibold px-4 py-1.5 rounded-lg transition-colors"
							>
								Send
							</button>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Inline JS for NIP-07 + WebSocket comment publishing -->
		<script>
			(function() {
				var RELAY = 'wss://relay.gambit.golf';
				var EVENT_ID = '{ params.Round.EventID }';
				var AUTHOR_PK = '{ params.Round.AuthorPubkey }';
				var _pubkeyHex = null;
				var _npub = null;
				var _displayName = null;
				var _picture = null;

				// --- bech32 encoding (same as homepage) ---
				var B32 = 'qpzry9x8gf2tvdw0s3jn54khce6mua7l';
				function b32poly(v) {
					var c=1,G=[0x3b6a57b2,0x26508e6d,0x1ea119fa,0x3d4233dd,0x2a1462b3];
					for(var i=0;i<v.length;i++){var b=c>>25;c=(c&0x1ffffff)<<5^v[i];for(var j=0;j<5;j++)if((b>>j)&1)c^=G[j];}return c;
				}
				function b32hrp(h){var r=[];for(var i=0;i<h.length;i++)r.push(h.charCodeAt(i)>>5);r.push(0);for(var i=0;i<h.length;i++)r.push(h.charCodeAt(i)&31);return r;}
				function b32chk(h,d){var v=b32hrp(h).concat(d).concat([0,0,0,0,0,0]);var m=b32poly(v)^1;var r=[];for(var i=0;i<6;i++)r.push((m>>(5*(5-i)))&31);return r;}
				function cvtBits(d,f,t){var a=0,b=0,r=[];for(var i=0;i<d.length;i++){a=(a<<f)|d[i];b+=f;while(b>=t){b-=t;r.push((a>>b)&((1<<t)-1));}}if(b>0)r.push((a<<(t-b))&((1<<t)-1));return r;}
				function hexToNpub(hex){var bytes=[];for(var i=0;i<hex.length;i+=2)bytes.push(parseInt(hex.slice(i,i+2),16));var w=cvtBits(bytes,8,5);return 'npub1'+w.concat(b32chk('npub',w)).map(function(v){return B32[v];}).join('');}

				// --- Fetch kind 0 profile ---
				function fetchProfile(pk) {
					return new Promise(function(resolve) {
						var ws = new WebSocket(RELAY);
						var result = null;
						var timer = setTimeout(function(){ws.close();resolve(result);}, 5000);
						ws.onopen = function() {
							ws.send(JSON.stringify(['REQ','prof',{kinds:[0],authors:[pk],limit:1}]));
						};
						ws.onmessage = function(msg) {
							try {
								var data = JSON.parse(msg.data);
								if (data[0] === 'EVENT' && data[1] === 'prof') {
									var meta = JSON.parse(data[2].content);
									result = {name: meta.name || meta.display_name || '', picture: meta.picture || ''};
								} else if (data[0] === 'EOSE') {
									clearTimeout(timer); ws.close(); resolve(result);
								}
							} catch(e) {}
						};
						ws.onerror = function() { clearTimeout(timer); resolve(result); };
					});
				}

				// --- Connect ---
				window.connectNostrComment = async function() {
					var btn = document.getElementById('nostr-login-btn');
					var txt = document.getElementById('nostr-login-text');
					var signer = window._nip07 || window.nostr;
					if (!signer) {
						txt.textContent = 'No extension found';
						setTimeout(function(){txt.textContent='Sign in with Nostr';},2500);
						return;
					}
					try {
						txt.textContent = 'Connecting...';
						btn.disabled = true;
						_pubkeyHex = await signer.getPublicKey();
						_npub = hexToNpub(_pubkeyHex);
						// Show compose box immediately with npub fallback
						var shortName = _npub.slice(0,10) + '...' + _npub.slice(-4);
						btn.classList.remove('bg-gray-800','hover:bg-gray-700');
						btn.classList.add('bg-green-800','cursor-default');
						txt.textContent = shortName;
						document.getElementById('comment-compose').classList.remove('hidden');
						document.getElementById('comment-input').addEventListener('input', function() {
							document.getElementById('comment-send-btn').disabled = !this.value.trim();
						});
						// Fetch profile in background for display name + avatar
						var profile = await fetchProfile(_pubkeyHex);
						if (profile) {
							if (profile.name) {
								_displayName = profile.name;
								txt.textContent = profile.name;
							}
							if (profile.picture) {
								_picture = profile.picture;
								var avatar = document.getElementById('compose-avatar');
								avatar.src = profile.picture;
								avatar.classList.remove('hidden');
							}
						}
					} catch(e) {
						btn.disabled = false;
						txt.textContent = 'Cancelled';
						setTimeout(function(){txt.textContent='Sign in with Nostr';},2000);
					}
				};

				// --- Send comment ---
				window.sendComment = async function() {
					var input = document.getElementById('comment-input');
					var content = input.value.trim();
					if (!content || !_pubkeyHex) return;
					var btn = document.getElementById('comment-send-btn');
					var status = document.getElementById('comment-status');
					btn.disabled = true;
					btn.textContent = 'Sending...';
					status.textContent = '';
					try {
						var signer = window._nip07 || window.nostr;
						var now = Math.floor(Date.now() / 1000);
						var evt = {
							kind: 1111,
							created_at: now,
							tags: [
								['E', EVENT_ID, RELAY, 'root'],
								['K', '1501'],
								['p', AUTHOR_PK],
								['type', 'banter']
							],
							content: content,
							pubkey: _pubkeyHex
						};
						var signed = await signer.signEvent(evt);
						// Publish via WebSocket
						await publishToRelay(signed);
						// Optimistic render
						appendComment({
							picture: _picture || '',
							name: _displayName || _npub.slice(0,10) + '...' + _npub.slice(-4),
							content: content,
							time: 'just now',
							type: 'banter',
							pinned: false
						});
						input.value = '';
						btn.disabled = true;
						btn.textContent = 'Send';
						status.textContent = 'Sent!';
						setTimeout(function(){status.textContent='';},2000);
					} catch(e) {
						btn.disabled = false;
						btn.textContent = 'Send';
						status.textContent = 'Error: ' + (e.message || 'Failed to send');
						status.classList.add('text-red-500');
						setTimeout(function(){status.textContent='';status.classList.remove('text-red-500');},3000);
					}
				};

				function publishToRelay(evt) {
					return new Promise(function(resolve, reject) {
						var ws = new WebSocket(RELAY);
						var timer = setTimeout(function(){ws.close();reject(new Error('timeout'));}, 8000);
						ws.onopen = function() {
							ws.send(JSON.stringify(['EVENT', evt]));
						};
						ws.onmessage = function(msg) {
							try {
								var data = JSON.parse(msg.data);
								if (data[0] === 'OK' && data[2] === true) {
									clearTimeout(timer);
									ws.close();
									resolve();
								} else if (data[0] === 'OK' && data[2] === false) {
									clearTimeout(timer);
									ws.close();
									reject(new Error(data[3] || 'Relay rejected'));
								}
							} catch(e) {}
						};
						ws.onerror = function() { clearTimeout(timer); reject(new Error('WebSocket error')); };
					});
				}

				function appendComment(c) {
					var list = document.getElementById('comments-list');
					var noMsg = document.getElementById('no-comments-msg');
					if (noMsg) noMsg.remove();
					var div = document.createElement('div');
					div.className = 'px-4 py-3';
					var avatarHtml = c.picture
						? '<img src="' + escHtml(c.picture) + '" alt="" class="w-7 h-7 rounded-full flex-shrink-0 mt-0.5"/>'
						: '<div class="w-7 h-7 rounded-full bg-green-200 flex-shrink-0 mt-0.5"></div>';
					div.innerHTML =
						'<div class="flex items-start gap-2.5">' +
						avatarHtml +
						'<div class="flex-1 min-w-0">' +
						'<div class="flex items-center gap-2">' +
						'<span class="text-sm font-semibold text-gray-900">' + escHtml(c.name) + '</span>' +
						'<span class="text-xs text-gray-400">' + escHtml(c.time) + '</span>' +
						'</div>' +
						'<p class="text-sm text-gray-700 mt-0.5 whitespace-pre-wrap break-words">' + escHtml(c.content) + '</p>' +
						'</div></div>';
					list.appendChild(div);
					div.scrollIntoView({behavior:'smooth', block:'nearest'});
				}

				function escHtml(s) {
					var d = document.createElement('div');
					d.appendChild(document.createTextNode(s));
					return d.innerHTML;
				}
			})();
		</script>

		<!-- App Link -->
		<div class="mt-4 p-4 bg-gradient-to-r from-green-50 to-blue-50 rounded-lg border border-green-200">
			<div class="flex items-center justify-between flex-wrap gap-2">
				<div>
					<h3 class="font-semibold text-gray-900">Gambit Golf</h3>
					<p class="text-sm text-gray-600">Play rounds with friends on the Nostr network</p>
				</div>
				<a href="https://gambit.golf" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
					Learn More
				</a>
			</div>
		</div>
	</div>
}

// Legacy helpers (used by golf_scorecard_page.templ) are in golf_data.go
